name: ubuntu-tests

on:
  workflow_dispatch:
    inputs:
      chaste_branch:
        description: 'Chaste branch'
        required: true
        type: string
        default: 'develop'

      boost_ver:
        description: 'Boost version'
        required: true
        type: string
        default: '1.74.0'

      hdf5_ver:
        description: 'HDF5 version'
        required: true
        type: string
        default: '1.10.8'

      petsc_ver:
        description: 'PETSc version'
        required: true
        type: string
        default: '3.15.5'

      petsc_arch:
        description: 'PETSc arch'
        required: true
        type: choice
        options:
          - 'linux-gnu'
          - 'linux-gnu-opt'
        default: 'linux-gnu'

      sundials_ver:
        description: 'SUNDIALS version'
        required: true
        type: string
        default: '5.8.0'

      vtk_ver:
        description: 'VTK version'
        required: true
        type: string
        default: '9.2.6'

      xercesc_ver:
        description: 'XercesC version'
        required: true
        type: string
        default: '3.2.4'

      xsd_ver:
        description: 'XSD version'
        required: true
        type: string
        default: '4.0.0'

      os:
        description: 'OS'
        required: true
        type: choice
        options:
          - 'ubuntu-20.04'
          - 'ubuntu-22.04'
        default: 'ubuntu-22.04'

jobs:
  setup:
    name: test modules on ubuntu

    runs-on: ${{ github.event.inputs.os }}

    steps:
      - name: checkout
        uses: actions/checkout@v3

      - name: setup os
        uses: ./.github/actions/setup-defaults

      - name: install and cache xsd module
        uses: ./.github/actions/setup-xsd
        with:
          xsd_ver: ${{ github.event.inputs.xsd_ver }}

      - name: build and cache sundials module
        uses: ./.github/actions/setup-sundials
        with:
          sundials_ver: ${{ github.event.inputs.sundials_ver }}

      - name: build and cache xercesc module
        uses: ./.github/actions/setup-xercesc
        with:
          xercesc_ver: ${{ github.event.inputs.xercesc_ver }}

      - name: build and cache boost module
        uses: ./.github/actions/setup-boost
        with:
          boost_ver: ${{ github.event.inputs.boost_ver }}

      - name: build and cache vtk module
        uses: ./.github/actions/setup-vtk
        with:
          vtk_ver: ${{ github.event.inputs.vtk_ver }}

      - name: build and cache petsc_hdf5 module
        uses: ./.github/actions/setup-petsc_hdf5
        with:
          hdf5_ver: ${{ github.event.inputs.hdf5_ver }}
          petsc_ver: ${{ github.event.inputs.petsc_ver }}
          petsc_arch: ${{ github.event.inputs.petsc_arch }}

      - name: checkout chaste
        uses: actions/checkout@v3
        with:
          repository: Chaste/Chaste
          path: Chaste
          ref: ${{ github.event.inputs.chaste_branch }}
          submodules: recursive

      - name: make build and test directories
        run: |
          mkdir -p chaste-build-dir
          mkdir -p chaste-test-dir
          echo "CHASTE_TEST_OUTPUT=$(pwd)/chaste-test-dir" >> ${GITHUB_ENV}

      - name: create module init script
        run: |
          echo "source /etc/profile.d/modules.sh" > init.sh
          echo "module use /home/runner/modules/modulefiles" >> init.sh
          echo "module purge" >> init.sh
          echo "module load boost" >> init.sh
          echo "module load petsc_hdf5" >> init.sh
          echo "module load sundials" >> init.sh
          echo "module load vtk" >> init.sh
          echo "module load xercesc" >> init.sh
          echo "module load xsd" >> init.sh
        working-directory: chaste-build-dir

      - name: cmake configure
        run: |
          source init.sh
          cmake .. \
            -DBoost_NO_BOOST_CMAKE=ON \
            -DBoost_NO_SYSTEM_PATHS=ON \
            -DBOOST_ROOT=${BOOST_ROOT} \
            -DCMAKE_BUILD_TYPE=Release
        working-directory: chaste-build-dir

      - name: compile build info
        run: |
          source init.sh
          cmake --build . --parallel $(nproc) --target TestChasteBuildInfo
          ctest -V -R TestChasteBuildInfo --output-on-failure | tee buildinfo
        working-directory: chaste-build-dir
          
      - name: verify dependency versions
        run: |
          sed -i.bak 's/"//g' buildinfo  # removes quotes from old sundials versions

          maj_min_rev='^[0-9]\+\.[0-9]\+\.[0-9]\+'
          maj_min='^[0-9]\+\.[0-9]\+'

          xsd_ver="$(echo ${{ github.event.inputs.xsd_ver }} | grep -o ${maj_min_rev})"
          xercesc_ver="$(echo ${{ github.event.inputs.xercesc_ver }} | grep -o ${maj_min_rev})"
          sundials_ver="$(echo ${{ github.event.inputs.sundials_ver }} | grep -o ${maj_min_rev})"
          boost_ver="$(echo ${{ github.event.inputs.boost_ver }} | grep -o ${maj_min_rev})"
          vtk_ver="$(echo ${{ github.event.inputs.vtk_ver }} | grep -o ${maj_min})"
          petsc_ver="$(echo ${{ github.event.inputs.petsc_ver }} | grep -o ${maj_min_rev})"
          hdf5_ver="$(echo ${{ github.event.inputs.hdf5_ver }} | grep -o ${maj_min_rev})"

          grep "<XSD>${xsd_ver}</XSD>" buildinfo
          grep "<Xerces>${xercesc_ver}</Xerces>" buildinfo
          grep "<SUNDIALS>${sundials_ver}</SUNDIALS>" buildinfo
          grep "<Boost>${boost_ver}</Boost>" buildinfo
          grep "<VTK>${vtk_ver}</VTK>" buildinfo
          grep "<PETSc>${petsc_ver}</PETSc>" buildinfo
          grep "<HDF5>${hdf5_ver}</HDF5>" buildinfo
        working-directory: chaste-build-dir
